@page "/"

@using DataModelLibrary.Models
@using EntityFrameworkAccess.Repositories
@using EntityFrameworkAccess.Contexts
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore

@inject CarMaintenanceDbContext CarMaintenanceDbContext

<title>Dashboard</title>

<div class="h2 mb-2">Brandon's 2015 Civic</div>
@if (_vehicle2015Civic is not null)
{
    <div class="h4 mb-2">Current Mileage: <span class="border border-2 border-dark p-1">@_vehicle2015Civic.CurrentMileage</span></div>
}
<QuickGrid TGridItem="ServiceRecordViewModel" Items="_serviceRecords2015Civic.AsQueryable()" Class="table table-bordered table-striped border-dark p-2" Theme="dashboardtable">
    <PropertyColumn Property="@(c => c.ServiceType)" Title="Service Type" Class="align-content-center" />
    <TemplateColumn Title="Date Last Serviced" Class="align-content-center">
        @if (context.DateLastServiced.HasValue)
        {
            @context.DateLastServiced.Value.ToString("MM/dd/yyyy")
        }
    </TemplateColumn>
    <PropertyColumn Property="@(c => c.MileageLastService)" Title="Mileage Last Service" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.RecommendedIntervalInMiles)" Title="Interval (Miles)" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.RecommendedIntervalInYears)" Title="Interval (Years)" Class="align-content-center" />
    <TemplateColumn Title="Next Due Mileage">
        <div class="due-cell" style="@GetDueMileageStyle(context)">
            @context.NextDueMileageDisplay
        </div>
    </TemplateColumn>
    <PropertyColumn Property="@(c => $"$" + c.EstimatedCost)" Title="Estimated Cost" Class="align-content-center" />
    <PropertyColumn Property="@(c => $"$" + c.CostLastService)" Title="Cost Last Service" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.ShopName)" Title="Shop Name" Class="align-content-center" />
</QuickGrid>

<div class="h2 mt-5 mb-2">Mallory's 2019 Civic</div>
@if (_vehicle2019Civic is not null)
{
    <div class="h4 mb-2">Current Mileage: <span class="border border-2 border-dark p-1">@_vehicle2019Civic.CurrentMileage</span></div>
}
<QuickGrid TGridItem="ServiceRecordViewModel" Items="_serviceRecords2019Civic.AsQueryable()" Class="table table-bordered table-striped border-dark p-2" Theme="dashboardtable">
    <PropertyColumn Property="@(c => c.ServiceType)" Title="Service Type" Class="align-content-center" />
    <TemplateColumn Title="Date Last Serviced" Class="align-content-center">
        @if (context.DateLastServiced.HasValue)
        {
            @context.DateLastServiced.Value.ToString("MM/dd/yyyy")
        }
    </TemplateColumn>
    <PropertyColumn Property="@(c => c.MileageLastService)" Title="Mileage Last Service" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.RecommendedIntervalInMiles)" Title="Interval (Miles)" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.RecommendedIntervalInYears)" Title="Interval (Years)" Class="align-content-center" />
    <TemplateColumn Title="Next Due Mileage">
        <div class="due-cell" style="@GetDueMileageStyle(context)">
            @context.NextDueMileageDisplay
        </div>
    </TemplateColumn>
    <PropertyColumn Property="@(c => $"$" + c.EstimatedCost)" Title="Estimated Cost" Class="align-content-center" />
    <PropertyColumn Property="@(c => $"$" + c.CostLastService)" Title="Cost Last Service" Class="align-content-center" />
    <PropertyColumn Property="@(c => c.ShopName)" Title="Shop Name" Class="align-content-center" />
</QuickGrid>

@code {
    private Vehicle? _vehicle2015Civic;
    private Vehicle? _vehicle2019Civic;
    private EntityRepository<Vehicle>? _vehicleRepository;
    private List<ServiceRecordViewModel> _serviceRecords2015Civic = [];
    private List<ServiceRecordViewModel> _serviceRecords2019Civic = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadVehiclesAsync();
        if (_vehicle2015Civic is null || _vehicle2019Civic is null)
            return;
        _serviceRecords2015Civic = await LoadServiceRecordViewModelsAsync(_vehicle2015Civic);
        _serviceRecords2019Civic = await LoadServiceRecordViewModelsAsync(_vehicle2019Civic);
    }

    private async Task LoadVehiclesAsync()
    {
        _vehicleRepository = new EntityRepository<Vehicle>(CarMaintenanceDbContext);
        var vehicles = await _vehicleRepository.GetAllAsync();
        _vehicle2015Civic = vehicles.FirstOrDefault(v => v!.DisplayName == "Brandons Car");
        _vehicle2019Civic = vehicles.FirstOrDefault(v => v!.DisplayName == "Mallorys Car");
    }

    private async Task<List<ServiceType>> LoadAllServiceTypes()
    {
        var serviceTypeRepository = new EntityRepository<ServiceType>(CarMaintenanceDbContext);
        return (await serviceTypeRepository.GetAllAsync()).ToList();
    }

    private async Task<List<ServiceRecordViewModel>> LoadServiceRecordViewModelsAsync(Vehicle vehicle)
    {
        var allServiceTypes = await LoadAllServiceTypes();
        var latestServiceRecords = await CarMaintenanceDbContext.ServiceRecords
            .Where(sr => sr.VehicleId == vehicle.Id)
            .GroupBy(sr => sr.ServiceTypeId)
            .Select(g => g
                .OrderByDescending(sr => sr.DateLastServiced)
                .ThenByDescending(x => x.Id)
                .First())
            .ToListAsync();

        var latestLookup = latestServiceRecords.ToDictionary(sr => sr.ServiceTypeId);

        return allServiceTypes.Select(st =>
        {
            latestLookup.TryGetValue(st.Id, out var record);

            var baseMileage = record?.MileageLastService ?? 0;

            int? nextMinMileage = st.RecommendedIntervalInMilesMinimum.HasValue
                ? baseMileage + st.RecommendedIntervalInMilesMinimum.Value
                : null;

            int? nextMaxMileage = st.RecommendedIntervalInMilesMaximum.HasValue
                ? baseMileage + st.RecommendedIntervalInMilesMaximum.Value
                : null;

            return new ServiceRecordViewModel
            {
                ServiceType = st.Type,
                DateLastServiced = record?.DateLastServiced,
                MileageLastService = record?.MileageLastService,
                CurrentMileage = vehicle.CurrentMileage,
                RecommendedIntervalInMiles = st.RecommendedIntervalInMilesMinimum.HasValue ? $"{st.RecommendedIntervalInMilesMinimum} - {st.RecommendedIntervalInMilesMaximum}" : null,
                RecommendedIntervalInYears = st.RecommendedIntervalInYears.HasValue ? st.RecommendedIntervalInYears.ToString() : null,
                NextDueMinMiles = nextMinMileage,
                NextDueMaxMiles = nextMaxMileage,
                EstimatedCost = st.EstimatedCost,
                CostLastService = record?.CostLastService,
                ShopName = record?.ShopName
            };
        }).ToList();
    }

    private static string GetDueMileageStyle(ServiceRecordViewModel row)
    {
        if (!row.CurrentMileage.HasValue || !row.NextDueMinMiles.HasValue || !row.NextDueMaxMiles.HasValue)
            return "";

        var current = row.CurrentMileage.Value;
        var min = row.NextDueMinMiles.Value;
        var max = row.NextDueMaxMiles.Value;

        if (max <= min) return "background:#e5e7eb;";

        // green - #80ef80
        // red - #ff4747
        // yellow - #ffee8c

        if (current < min) return "background:#80ef80;";
        if (current >= max) return "background:#ff4747;";

        var p = (double)(current - min) / (max - min);
        p = Math.Clamp(p, 0.0, 1.0);

        if (p <= 0.5)
        {
            var yellowPct = (p / 0.5) * 100.0;
            return $"background:linear-gradient(90deg,#ffee8c {yellowPct:F1}%,#80ef80 {yellowPct:F1}%);";
        }
        else
        {
            var redPct = ((p - 0.5) / 0.5) * 100.0;
            return $"background:linear-gradient(90deg,#ff4747 {redPct:F1}%,#ffee8c {redPct:F1}%);";
        }
    }

    private sealed class ServiceRecordViewModel
    {
        public string ServiceType { get; set; } = string.Empty;
        public DateTime? DateLastServiced { get; set; }
        public int? MileageLastService { get; set; }
        public int? CurrentMileage { get; set; }
        public string? RecommendedIntervalInMiles { get; set; }
        public string? RecommendedIntervalInYears { get; set; }
        public int? NextDueMinMiles { get; set; }
        public int? NextDueMaxMiles { get; set; }
        public string NextDueMileageDisplay =>
        (NextDueMinMiles.HasValue && NextDueMaxMiles.HasValue)
            ? $"{NextDueMinMiles.Value:N0} - {NextDueMaxMiles.Value:N0}"
            : "";
        public int? EstimatedCost { get; set; }
        public decimal? CostLastService { get; set; }
        public string? ShopName { get; set; }
    }
}