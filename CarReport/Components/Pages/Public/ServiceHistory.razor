@page "/service-history/{VehicleId:int}"

@using DataModelLibrary.Models
@using EntityFrameworkAccess.Contexts
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore

@inject CarMaintenanceDbContext CarMaintenanceDbContext

<title>2015 Civic History</title>

@if (_currentVehicle is not null)
{
    <div class="h3 mb-3">Historical Data for @_currentVehicle.DisplayName</div>
}

<QuickGrid Items="_serviceRecordHistory.AsQueryable()" Class="table table-bordered table-striped border-dark p-2">
    <PropertyColumn Property="sr => sr.ServiceType" Title="Service Type"></PropertyColumn>
    <TemplateColumn Title="Date Last Serviced" Class="align-content-center">
        @if (context.DateLastServiced.HasValue)
        {
            @context.DateLastServiced.Value.ToString("MM/dd/yyyy")
        }
    </TemplateColumn>
    <PropertyColumn Property="sr => sr.MileageLastService" Title="Mileage Last Service"></PropertyColumn>
    <PropertyColumn Property="sr => sr.CostLastService" Title="Cost Last Service"></PropertyColumn>
    <PropertyColumn Property="sr => sr.ShopName" Title="Shop Name"></PropertyColumn>
    <PropertyColumn Property="sr => sr.Notes" Title="Notes"></PropertyColumn>
</QuickGrid>

@code {
    [Parameter]
    public int VehicleId { get; set; }

    Vehicle? _currentVehicle = default!;
    List<ServiceRecordViewModel> _serviceRecordHistory = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadCurrentVehicle();
        if (_currentVehicle is not null)
            await LoadServiceRecords2015Civic(_currentVehicle);
    }

    private async Task LoadCurrentVehicle()
    {
        _currentVehicle = await CarMaintenanceDbContext.Vehicles
            .AsNoTracking()
            .FirstOrDefaultAsync(v => v.Id == VehicleId);
    }

    private async Task LoadServiceRecords2015Civic(Vehicle vehicle)
    {
        var records = await CarMaintenanceDbContext.ServiceRecords
            .AsNoTracking()
            .Where(sr => sr.VehicleId == vehicle.Id)
            .Include(sr => sr.ServiceType)
            .OrderByDescending(sr => sr.DateLastServiced)
            .ToListAsync();

        _serviceRecordHistory = records.Select(sr => new ServiceRecordViewModel
        {
            ServiceType = sr.ServiceType.Type,
            DateLastServiced = sr.DateLastServiced,
            MileageLastService = sr.MileageLastService,
            CostLastService = sr.CostLastService,
            ShopName = sr.ShopName,
            Notes = sr.Notes
        }).ToList();
    }

    private sealed class ServiceRecordViewModel
    {
        public string ServiceType { get; set; } = string.Empty;
        public DateTime? DateLastServiced { get; set; }
        public int? MileageLastService { get; set; }
        public decimal? CostLastService { get; set; }
        public string? ShopName { get; set; }
        public string? Notes { get; set; }
    }
}
